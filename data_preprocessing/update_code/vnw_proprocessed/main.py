import pandas as pd
import os
import json
from google.oauth2 import service_account
from datetime import datetime
import uuid
import gspread                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          

# Google Sheet setup
SCOPES = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
SERVICE_ACCOUNT_FILE = r'C:\working\job_rcm\job_rcm_code\job_scraping\job-rcm-luan-0e530aa9b6a0.json'

credentials = service_account.Credentials.from_service_account_file(
    SERVICE_ACCOUNT_FILE, scopes=SCOPES)
client = gspread.authorize(credentials)
sheet = client.open_by_key("1cXvQDtzkcjoYaZ0F2tVqwpLaS14M_00m2Qi8zDAmy_o").worksheet("logs")


####################################
# Log system code ##################
####################################

# Function to generate a unique log ID
def generate_log_id(scraping_type):
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    random_suffix = str(uuid.uuid4())[:3]
    return f"VIPR_{timestamp}_{random_suffix}_{scraping_type}"

# Function to write a start log entry
def write_start_log(log_id, scraping_type, keywords=""):
    sheet.append_row([
            log_id,
            'vietnamwork',
            scraping_type,
            'Started',
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'),  # Start time
            '',  # End time (empty for start log)
            0,   # Duration (0 for start log)
            0,   # Total keywords (will be updated in end log)
            0,   # Total jobs (will be updated in end log)
            0,   # New jobs (will be updated in end log)
            0,   # Error count (will be updated in end log)
            '',  # Error details (will be updated in end log)
            keywords  # Keywords
        ])
    return log_id

# Function to write an end log entry
def write_end_log(log_id, scraping_type, start_time, status, total_keywords=0, total_jobs=0,new_jobs=0, error_count=0, error_details="", keywords=""):
    end_time = datetime.now()
    start_datetime = datetime.strptime(start_time, '%Y-%m-%d %H:%M:%S')
    duration = int((end_time - start_datetime).total_seconds())
    
    sheet.append_row([
            log_id,
            'vietnamwork',
            scraping_type,
            status,
            start_time,
            end_time.strftime('%Y-%m-%d %H:%M:%S'),
            duration,
            total_keywords,
            total_jobs,
            new_jobs,
            error_count,
            error_details,
            keywords
        ])


preprocess_log_id = generate_log_id("preprocess")
preprocess_start_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
scraping_type = "preprocess"
# Ghi log bắt đầu
write_start_log(preprocess_log_id, scraping_type, keywords="vietnamwork processing")

# Đường dẫn
base_dir = r"C:\working\job_rcm\data\vietnamwork"
merged_output_path = r'C:\working\job_rcm\data\preprocessed\vietnamwork\merged_data.json'
csv_output_path = r'C:\working\job_rcm\data\preprocessed\vietnamwork\preprocessed_data.csv'

# Bước 1: Duyệt qua các thư mục con chứa "Detailview" và lấy data.json
all_ld_posts = []

for root, dirs, files in os.walk(base_dir):
    if 'Detailview' in root:  # Chỉ lấy các thư mục chứa "Detailview"
        for file in files:
            if file == 'data.json':
                file_path = os.path.join(root, file)
                with open(file_path, 'r', encoding='utf-8') as f:
                    try:
                        data = json.load(f)
                        all_ld_posts.append(data)
                    except Exception as e:
                        print(f"Lỗi khi đọc {file_path}: {e}")

# Bước 2: Ghi dữ liệu đã hợp nhất ra file JSON
with open(merged_output_path, 'w', encoding='utf-8') as f:
    json.dump(all_ld_posts, f, ensure_ascii=False, indent=4)

print(f"Dữ liệu đã được hợp nhất thành công và lưu vào file '{merged_output_path}'")
msg = f"Dữ liệu đã được hợp nhất thành công và lưu vào file '{merged_output_path}'"

# Bước 3: Đọc lại dữ liệu từ file JSON
with open(merged_output_path, 'r', encoding='utf-8') as f:
    data = json.load(f)

# Bước 4: Trích xuất danh sách công việc (job)
all_ld_jobs = [job for item in data if "job" in item for job in item["job"]]

# Bước 5: Chuyển sang DataFrame
ld_df = pd.DataFrame(all_ld_jobs)

# Bước 6: Xử lý thời gian scrape_date nếu có
if 'scrape_date' in ld_df.columns:
    ld_df['scrape_date'] = pd.to_datetime(ld_df['scrape_date'], format="%Y-%m-%dT%H:%M:%S.%f", errors='coerce')
    ld_df['scrape_date'] = ld_df['scrape_date'].dt.strftime("%Y-%m-%d %H:%M")

# Bước 7: Lưu ra file CSV
ld_df.to_csv(csv_output_path, index=False, encoding='utf-8')
print(f"Dữ liệu đã được lưu vào: {csv_output_path}")
msg = f"Dữ liệu đã được lưu vào: {csv_output_path}"


# Bước 8: Ghi log kết thúc
write_end_log(
    log_id=preprocess_log_id,
    scraping_type=scraping_type,
    start_time=preprocess_start_time,
    status='Completed',
    total_keywords=0,
    total_jobs=0,
    new_jobs=0,  # Giả sử tất cả là job mới
    error_count=0,
    error_details="",
    keywords=msg,
)